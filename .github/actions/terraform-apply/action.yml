name: 'Apply Terraform'
description: 'Run a terraform apply command to apply the changes.'

inputs:
  environment:
    required: true
    description: 'The environment to deploy to.'
  ref:
    required: true
    description: 'The git ref to deploy.'
  ssh-key:
    required: true
    description: 'The SSH key to use for fetching modules from github.'
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4.1.0
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.IAM_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.8
    - uses: ./.github/actions/setup-ssh
      with:
        ssh-key: ${{ inputs.ssh-key }}
    - run: cd terraform && terraform init -backend-config=backends/${{ inputs.environment }}.tfbackend
      shell: bash
    - run: cd terraform && terraform apply -var-file=config_${{ inputs.environment }}.tfvars -auto-approve
      shell: bash
      env:
        TF_VAR_docker_tag: ${{ inputs.ref }}
